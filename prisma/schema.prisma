// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Usuario del sistema
model User {
    id        String   @id @default(uuid())
    email     String   @unique
    password  String
    name      String?
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    contacts     Contact[]
    companies    Company[]
    deals        Deal[]
    interactions Interaction[]
    reminders    Reminder[]

    @@map("users")
}

// Empresas/Organizaciones
model Company {
    id        String   @id @default(uuid())
    name      String
    email     String?
    phone     String?
    website   String?
    address   String?
    userId    String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    contacts     Contact[]
    deals        Deal[]
    interactions Interaction[]

    @@map("companies")
}

// Contactos individuales
model Contact {
    id        String   @id @default(uuid())
    firstName String
    lastName  String
    email     String?
    phone     String?
    position  String?
    companyId String?
    userId    String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    company      Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)
    deals        Deal[]
    interactions Interaction[]

    @@map("contacts")
}

// Oportunidades de negocio / Pipeline
model Deal {
    id                String    @id @default(uuid())
    title             String
    description       String?   @db.Text
    value             Decimal   @db.Decimal(10, 2)
    stage             DealStage @default(PROSPECTO)
    contactId         String?
    companyId         String?
    userId            String
    expectedCloseDate DateTime?
    closedAt          DateTime?
    createdAt         DateTime  @default(now())
    updatedAt         DateTime  @updatedAt

    user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    contact      Contact?      @relation(fields: [contactId], references: [id], onDelete: SetNull)
    company      Company?      @relation(fields: [companyId], references: [id], onDelete: SetNull)
    quotes       Quote[]
    invoices     Invoice[]
    reminders    Reminder[]
    interactions Interaction[]

    @@map("deals")
}

enum DealStage {
    PROSPECTO
    CONTACTADO
    PROPUESTA_ENVIADA
    NEGOCIACION
    CERRADO_GANADO
    CERRADO_PERDIDO
}

// Cotizaciones/Propuestas
model Quote {
    id          String      @id @default(uuid())
    dealId      String
    quoteNumber String      @unique
    items       Json // Array de { description, quantity, unitPrice, total }
    subtotal    Decimal     @db.Decimal(10, 2)
    tax         Decimal     @db.Decimal(10, 2)
    total       Decimal     @db.Decimal(10, 2)
    status      QuoteStatus @default(BORRADOR)
    validUntil  DateTime?
    notes       String?     @db.Text
    sentAt      DateTime?
    createdAt   DateTime    @default(now())
    updatedAt   DateTime    @updatedAt

    deal     Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
    invoices Invoice[]

    @@map("quotes")
}

enum QuoteStatus {
    BORRADOR
    ENVIADA
    ACEPTADA
    RECHAZADA
}

// Facturas
model Invoice {
    id            String        @id @default(uuid())
    dealId        String
    quoteId       String?
    invoiceNumber String        @unique
    items         Json // Array de { description, quantity, unitPrice, total }
    subtotal      Decimal       @db.Decimal(10, 2)
    tax           Decimal       @db.Decimal(10, 2)
    total         Decimal       @db.Decimal(10, 2)
    status        InvoiceStatus @default(PENDIENTE)
    dueDate       DateTime
    paidAt        DateTime?
    notes         String?       @db.Text
    createdAt     DateTime      @default(now())
    updatedAt     DateTime      @updatedAt

    deal  Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
    quote Quote? @relation(fields: [quoteId], references: [id], onDelete: SetNull)

    @@map("invoices")
}

enum InvoiceStatus {
    PENDIENTE
    PAGADA
    VENCIDA
    CANCELADA
}

// Historial de interacciones
model Interaction {
    id              String          @id @default(uuid())
    type            InteractionType
    subject         String?
    notes           String?         @db.Text
    contactId       String?
    companyId       String?
    dealId          String?
    userId          String
    interactionDate DateTime        @default(now())
    createdAt       DateTime        @default(now())

    user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    contact Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
    company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
    deal    Deal?    @relation(fields: [dealId], references: [id], onDelete: SetNull)

    @@map("interactions")
}

enum InteractionType {
    EMAIL
    LLAMADA
    REUNION
    NOTA
    WHATSAPP
}

// Recordatorios
model Reminder {
    id          String    @id @default(uuid())
    dealId      String
    userId      String
    message     String
    dueDate     DateTime
    completed   Boolean   @default(false)
    completedAt DateTime?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

    @@map("reminders")
}
